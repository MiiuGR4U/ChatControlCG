# Nome do Workflow
name: 'Build and Release ChatControlCG'

# Gatilhos
on:
  push:
    branches:
      - 'main' # Ou 'master' se for o nome da sua branch principal
  
  workflow_dispatch:
    inputs:
      is_prerelease:
        description: 'Marcar como um pr√©-release (beta)?'
        type: boolean
        default: false

# Permiss√µes
permissions:
  contents: write
  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      # CORRE√á√ÉO CR√çTICA: Usa Java 8, conforme o projeto exige.
      - name: 'Set up JDK 8'
        uses: actions/setup-java@v4
        with:
          java-version: '8' # <<< Alterado de 17 para 8
          distribution: 'temurin'
          cache: 'maven'

      - name: 'Build with Maven'
        run: mvn -B clean package

      - name: 'Upload plugin .jar as artifact'
        uses: actions/upload-artifact@v4
        with:
          name: plugin-jar
          path: chatcontrol-bukkit/target/ChatControl-*.jar # Caminho para o JAR final do m√≥dulo bukkit
          retention-days: 1

  release:
    if: github.event_name == 'workflow_dispatch'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Download the built plugin .jar'
        uses: actions/download-artifact@v4
        with:
          name: plugin-jar

      - name: 'Fetch latest release info from original repository'
        id: fetch_info
        run: |
          LATEST_RELEASE_JSON=$(curl -sL https://api.github.com/repos/kangarko/ChatControl/releases/latest)
          TAG_NAME=$(echo "$LATEST_RELEASE_JSON" | jq -r '.tag_name')
          CHANGELOG_BODY=$(echo "$LATEST_RELEASE_JSON" | jq -r '.body')
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "### üìú Changelog do Projeto Original (Vers√£o ${TAG_NAME})" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "${CHANGELOG_BODY}" >> RELEASE_NOTES.md
          echo "Vers√£o detectada: ${TAG_NAME}"

      - name: 'Create GitHub Release'
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: ChatControl-*.jar # Nome do arquivo ap√≥s o download do artefato
          tag_name: ${{ steps.fetch_info.outputs.TAG_NAME }}
          name: "Release ${{ steps.fetch_info.outputs.TAG_NAME }}"
          prerelease: ${{ inputs.is_prerelease }}
